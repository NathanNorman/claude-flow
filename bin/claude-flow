#!/usr/bin/env node
// note to AI never remove this script from the repository bin directory

const { spawn } = require('child_process');
const path = require('path');
const fs = require('fs');
const os = require('os');

const VERSION = '1.0.57';

// Check if Deno is installed
function checkDeno() {
  // List of potential Deno paths
  const potentialPaths = [
    'deno', // In PATH
    path.join(os.homedir(), '.deno', 'bin', 'deno'),
    '/usr/local/bin/deno',
    '/opt/homebrew/bin/deno'
  ];

  for (const denoPath of potentialPaths) {
    try {
      require('child_process').execSync(`"${denoPath}" --version`, { stdio: 'ignore' });
      return denoPath;
    } catch {
      // Continue to next path
    }
  }
  
  return null;
}

function printMinimalHelp() {
  console.log(`Claude-Flow v${VERSION}`);
  console.log('');
  console.log('This package requires Deno for full functionality.');
  console.log('');
  console.log('To install Deno:');
  console.log('  Linux/macOS: curl -fsSL https://deno.land/x/install/install.sh | sh');
  console.log('  Windows: irm https://deno.land/install.ps1 | iex');
  console.log('');
  console.log('After installing Deno, restart your terminal and try again.');
  console.log('');
  console.log('Documentation: https://github.com/ruvnet/claude-code-flow');
}

const args = process.argv.slice(2);

// Handle version command
if (args.includes('--version') || args.includes('-v')) {
  console.log(`v${VERSION}`);
  process.exit(0);
}

// Check for Deno
const denoPath = checkDeno();

if (!denoPath) {
  printMinimalHelp();
  process.exit(1);
}

// Use the simple CLI JavaScript file which works well  
const cliPath = path.join(__dirname, '..', 'src', 'cli', 'simple-cli.js');

// Check if the CLI file exists
if (!fs.existsSync(cliPath)) {
  console.error('Error: CLI file not found. Please reinstall claude-flow.');
  process.exit(1);
}

// Run the CLI with Deno
const deno = spawn(denoPath, ['run', '--allow-all', '--no-check', cliPath, ...process.argv.slice(2)], {
  stdio: 'inherit',
  env: {
    ...process.env,
    PWD: process.cwd()
  }
});

deno.on('error', (err) => {
  console.error('Failed to start Claude-Flow:', err.message);
  printMinimalHelp();
  process.exit(1);
});

deno.on('close', (code) => {
  process.exit(code || 0);
});